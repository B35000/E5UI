"use strict";(self.webpackChunkold_e5=self.webpackChunkold_e5||[]).push([[902],{44902(e,t,a){a.r(t),a.d(t,{MP4Parser:()=>V});var n=a(81760),s=a(70124),i=a(56067),r=a(22646),o=a(90070),c=a(92419);const l=n("music-metadata:parser:MP4:atom");class h extends((0,c.fO)("MP4")){}const d={len:8,get:(e,t)=>{const a=s.UINT32_BE.get(e,t);if(a<0)throw new h("Invalid atom header length");return{length:BigInt(a),name:new s.StringType(4,"latin1").get(e,t+4)}},put:(e,t,a)=>(s.UINT32_BE.put(e,t,Number(a.length)),o.e.put(e,t+4,a.name))},m=s.UINT64_BE,g={len:4,get:(e,t)=>({type:new s.StringType(4,"ascii").get(e,t)})};class u{constructor(e,t,a){if(this.len=e,e<t)throw new h("Atom ".concat(a," expected to be ").concat(t,", but specifies ").concat(e," bytes long."));e>t&&l("Warning: atom ".concat(a," expected to be ").concat(t,", but was actually ").concat(e," bytes long."))}}const p=(e,t)=>{const a=s.UINT32_BE.get(e,t)-2082844800;return new Date(1e3*a)};class T extends u{constructor(e){super(e,24,"mdhd"),this.len=e}get(e,t){return{version:s.UINT8.get(e,t+0),flags:s.UINT24_BE.get(e,t+1),creationTime:p(e,t+4),modificationTime:p(e,t+8),timeScale:s.UINT32_BE.get(e,t+12),duration:s.UINT32_BE.get(e,t+16),language:s.UINT16_BE.get(e,t+20),quality:s.UINT16_BE.get(e,t+22)}}}class f extends u{constructor(e){super(e,100,"mvhd"),this.len=e}get(e,t){return{version:s.UINT8.get(e,t),flags:s.UINT24_BE.get(e,t+1),creationTime:p(e,t+4),modificationTime:p(e,t+8),timeScale:s.UINT32_BE.get(e,t+12),duration:s.UINT32_BE.get(e,t+16),preferredRate:s.UINT32_BE.get(e,t+20),preferredVolume:s.UINT16_BE.get(e,t+24),previewTime:s.UINT32_BE.get(e,t+72),previewDuration:s.UINT32_BE.get(e,t+76),posterTime:s.UINT32_BE.get(e,t+80),selectionTime:s.UINT32_BE.get(e,t+84),selectionDuration:s.UINT32_BE.get(e,t+88),currentTime:s.UINT32_BE.get(e,t+92),nextTrackID:s.UINT32_BE.get(e,t+96)}}}class k{constructor(e){this.len=e}get(e,t){return{type:{set:s.UINT8.get(e,t+0),type:s.UINT24_BE.get(e,t+1)},locale:s.UINT24_BE.get(e,t+4),value:new s.Uint8ArrayType(this.len-8).get(e,t+8)}}}class w{constructor(e){this.len=e}get(e,t){return{version:s.UINT8.get(e,t),flags:s.UINT24_BE.get(e,t+1),name:new s.StringType(this.len-4,"utf-8").get(e,t+4)}}}class I{constructor(e){this.len=e}get(e,t){return{version:s.UINT8.get(e,t),flags:s.UINT24_BE.get(e,t+1),creationTime:p(e,t+4),modificationTime:p(e,t+8),trackId:s.UINT32_BE.get(e,t+12),duration:s.UINT32_BE.get(e,t+20),layer:s.UINT16_BE.get(e,t+24),alternateGroup:s.UINT16_BE.get(e,t+26),volume:s.UINT16_BE.get(e,t+28)}}}const y=8,E=(e,t)=>({version:s.UINT8.get(e,t),flags:s.UINT24_BE.get(e,t+1),numberOfEntries:s.UINT32_BE.get(e,t+4)});class N{constructor(e){this.len=e}get(e,t){const a=this.len-12;return{dataFormat:o.e.get(e,t),dataReferenceIndex:s.UINT16_BE.get(e,t+10),description:a>0?new s.Uint8ArrayType(a).get(e,t+12):void 0}}}class B{constructor(e){this.len=e}get(e,t){const a=E(e,t);t+=y;const n=[];for(let i=0;i<a.numberOfEntries;++i){const a=s.UINT32_BE.get(e,t);t+=s.UINT32_BE.len,n.push(new N(a-s.UINT32_BE.len).get(e,t)),t+=a}return{header:a,table:n}}}const _={len:8,get:(e,t)=>({version:s.INT16_BE.get(e,t),revision:s.INT16_BE.get(e,t+2),vendor:s.INT32_BE.get(e,t+4)})},b={len:12,get:(e,t)=>({numAudioChannels:s.INT16_BE.get(e,t+0),sampleSize:s.INT16_BE.get(e,t+2),compressionId:s.INT16_BE.get(e,t+4),packetSize:s.INT16_BE.get(e,t+6),sampleRate:s.UINT16_BE.get(e,t+8)+s.UINT16_BE.get(e,t+10)/1e4})};class U{constructor(e,t){this.len=e,this.token=t}get(e,t){const a=s.INT32_BE.get(e,t+4);return{version:s.INT8.get(e,t+0),flags:s.INT24_BE.get(e,t+1),numberOfEntries:a,entries:x(e,this.token,t+8,this.len-8,a)}}}const S={len:8,get:(e,t)=>({count:s.INT32_BE.get(e,t+0),duration:s.INT32_BE.get(e,t+4)})};class z extends U{constructor(e){super(e,S),this.len=e}}const v={len:12,get:(e,t)=>({firstChunk:s.INT32_BE.get(e,t),samplesPerChunk:s.INT32_BE.get(e,t+4),sampleDescriptionId:s.INT32_BE.get(e,t+8)})};class C extends U{constructor(e){super(e,v),this.len=e}}class A{constructor(e){this.len=e}get(e,t){const a=s.INT32_BE.get(e,t+8);return{version:s.INT8.get(e,t),flags:s.INT24_BE.get(e,t+1),sampleSize:s.INT32_BE.get(e,t+4),numberOfEntries:a,entries:x(e,s.INT32_BE,t+12,this.len-12,a)}}}class P extends U{constructor(e){super(e,s.INT32_BE),this.len=e}}class D{constructor(e){this.len=e}get(e,t){const a=s.INT16_BE.get(e,t+0);return new s.StringType(a,"utf-8").get(e,t+2)}}function x(e,t,a,n,s){if(l("remainingLen=".concat(n,", numberOfEntries=").concat(s," * token-len=").concat(t.len)),0===n)return[];if(n!==s*t.len)throw new h("mismatch number-of-entries with remaining atom-length");const i=[];for(let r=0;r<s;++r)i.push(t.get(e,a)),a+=t.len;return i}const O=n("music-metadata:parser:MP4:Atom");class F{static async readAtom(e,t,a,n){const s=e.position;O("Reading next token on offset=".concat(s,"..."));const i=await e.readToken(d),r=1n===i.length;r&&(i.length=await e.readToken(m));const o=new F(i,r,a),c=o.getPayloadLength(n);return O("parse atom name=".concat(o.atomPath,", extended=").concat(o.extended,", offset=").concat(s,", len=").concat(o.header.length)),await o.readData(e,t,c),o}constructor(e,t,a){this.header=e,this.extended=t,this.parent=a,this.children=[],this.atomPath=(this.parent?"".concat(this.parent.atomPath,"."):"")+this.header.name}getHeaderLength(){return this.extended?16:8}getPayloadLength(e){return(0n===this.header.length?e:Number(this.header.length))-this.getHeaderLength()}async readAtoms(e,t,a){for(;a>0;){const n=await F.readAtom(e,t,this,a);this.children.push(n),a-=0n===n.header.length?a:Number(n.header.length)}}async readData(e,t,a){switch(this.header.name){case"moov":case"udta":case"trak":case"mdia":case"minf":case"stbl":case"<id>":case"ilst":case"tref":return this.readAtoms(e,t,this.getPayloadLength(a));case"meta":{const n="hdlr"===(await e.peekToken(d)).name?0:4;return await e.ignore(n),this.readAtoms(e,t,this.getPayloadLength(a)-n)}default:return t(this,a)}}}var L=a(41124),M=a(36944);const R=n("music-metadata:parser:MP4"),W={raw:{lossy:!1,format:"raw"},MAC3:{lossy:!0,format:"MACE 3:1"},MAC6:{lossy:!0,format:"MACE 6:1"},ima4:{lossy:!0,format:"IMA 4:1"},ulaw:{lossy:!0,format:"uLaw 2:1"},alaw:{lossy:!0,format:"uLaw 2:1"},Qclp:{lossy:!0,format:"QUALCOMM PureVoice"},".mp3":{lossy:!0,format:"MPEG-1 layer 3"},alac:{lossy:!1,format:"ALAC"},"ac-3":{lossy:!0,format:"AC-3"},mp4a:{lossy:!0,format:"MPEG-4/AAC"},mp4s:{lossy:!0,format:"MP4S"},c608:{lossy:!0,format:"CEA-608"},c708:{lossy:!0,format:"CEA-708"}};function j(e,t,a){return a.indexOf(e)===t}class V extends i.s{constructor(){super(...arguments),this.tracks=[],this.atomParsers={mvhd:async e=>{const t=await this.tokenizer.readToken(new f(e));this.metadata.setFormat("creationTime",t.creationTime),this.metadata.setFormat("modificationTime",t.modificationTime)},mdhd:async e=>{const t=await this.tokenizer.readToken(new T(e)),a=this.getTrackDescription();a.creationTime=t.creationTime,a.modificationTime=t.modificationTime,a.timeScale=t.timeScale,a.duration=t.duration},chap:async e=>{const t=this.getTrackDescription(),a=[];for(;e>=s.UINT32_BE.len;)a.push(await this.tokenizer.readNumber(s.UINT32_BE)),e-=s.UINT32_BE.len;t.chapterList=a},tkhd:async e=>{const t=await this.tokenizer.readToken(new I(e));this.tracks.push(t)},mdat:async e=>{if(this.audioLengthInBytes=e,this.calculateBitRate(),this.options.includeChapters){const t=this.tracks.filter(e=>e.chapterList);if(1===t.length){const a=t[0].chapterList,n=this.tracks.filter(e=>-1!==a.indexOf(e.trackId));if(1===n.length)return this.parseChapterTrack(n[0],t[0],e)}}await this.tokenizer.ignore(e)},ftyp:async e=>{const t=[];for(;e>0;){const a=await this.tokenizer.readToken(g);e-=g.len;const n=a.type.replace(/\W/g,"");n.length>0&&t.push(n)}R("ftyp: ".concat(t.join("/")));const a=t.filter(j).join("/");this.metadata.setFormat("container",a)},stsd:async e=>{const t=await this.tokenizer.readToken(new B(e));this.getTrackDescription().soundSampleDescription=t.table.map(e=>this.parseSoundSampleDescription(e))},stsc:async e=>{const t=await this.tokenizer.readToken(new C(e));this.getTrackDescription().sampleToChunkTable=t.entries},stts:async e=>{const t=await this.tokenizer.readToken(new z(e));this.getTrackDescription().timeToSampleTable=t.entries},stsz:async e=>{const t=await this.tokenizer.readToken(new A(e)),a=this.getTrackDescription();a.sampleSize=t.sampleSize,a.sampleSizeTable=t.entries},stco:async e=>{const t=await this.tokenizer.readToken(new P(e));this.getTrackDescription().chunkOffsetTable=t.entries},date:async e=>{const t=await this.tokenizer.readToken(new s.StringType(e,"utf-8"));await this.addTag("date",t)}}}static read_BE_Integer(e,t){const a=(t?"INT":"UINT")+8*e.length+(e.length>1?"_BE":""),n=s[a];if(!n)throw new h('Token for integer type not found: "'.concat(a,'"'));return Number(n.get(e,0))}async parse(){this.tracks=[];let e=this.tokenizer.fileInfo.size||0;for(;!this.tokenizer.fileInfo.size||e>0;){try{if("\0\0\0\0"===(await this.tokenizer.peekToken(d)).name){const e="Error at offset=".concat(this.tokenizer.position,": box.id=0");R(e),this.addWarning(e);break}}catch(n){if(!(n instanceof Error))throw n;{const e="Error at offset=".concat(this.tokenizer.position,": ").concat(n.message);R(e),this.addWarning(e)}break}const t=await F.readAtom(this.tokenizer,(e,t)=>this.handleAtom(e,t),null,e);e-=t.header.length===BigInt(0)?e:Number(t.header.length)}const t=[];this.tracks.forEach(e=>{const a=[];e.soundSampleDescription.forEach(e=>{const t={},n=W[e.dataFormat];if(n?(a.push(n.format),t.codecName=n.format):t.codecName="<".concat(e.dataFormat,">"),e.description){const{description:a}=e;a.sampleRate>0&&(t.type=L.S.audio,t.audio={samplingFrequency:a.sampleRate,bitDepth:a.sampleSize,channels:a.numAudioChannels})}this.metadata.addStreamInfo(t)}),a.length>=1&&t.push(a.join("/"))}),t.length>0&&this.metadata.setFormat("codec",t.filter(j).join("+"));const a=this.tracks.filter(e=>e.soundSampleDescription.length>=1&&e.soundSampleDescription[0].description&&e.soundSampleDescription[0].description.numAudioChannels>0);if(a.length>=1){const e=a[0];if(e.timeScale>0){const t=e.duration/e.timeScale;this.metadata.setFormat("duration",t)}const t=e.soundSampleDescription[0];if(t.description&&(this.metadata.setFormat("sampleRate",t.description.sampleRate),this.metadata.setFormat("bitsPerSample",t.description.sampleSize),this.metadata.setFormat("numberOfChannels",t.description.numAudioChannels),0===e.timeScale&&e.timeToSampleTable.length>0)){const a=e.timeToSampleTable.map(e=>e.count*e.duration).reduce((e,t)=>e+t)/t.description.sampleRate;this.metadata.setFormat("duration",a)}const n=W[t.dataFormat];n&&this.metadata.setFormat("lossless",!n.lossy),this.calculateBitRate()}}async handleAtom(e,t){if(e.parent)switch(e.parent.header.name){case"ilst":case"<id>":return this.parseMetadataItemData(e)}if(this.atomParsers[e.header.name])return this.atomParsers[e.header.name](t);R("No parser for atom path=".concat(e.atomPath,", payload-len=").concat(t,", ignoring atom")),await this.tokenizer.ignore(t)}getTrackDescription(){return this.tracks[this.tracks.length-1]}calculateBitRate(){this.audioLengthInBytes&&this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLengthInBytes/this.metadata.format.duration)}async addTag(e,t){await this.metadata.addTag("iTunes",e,t)}addWarning(e){R("Warning: ".concat(e)),this.metadata.addWarning(e)}parseMetadataItemData(e){let t=e.header.name;return e.readAtoms(this.tokenizer,async(e,a)=>{const n=e.getPayloadLength(a);switch(e.header.name){case"data":return this.parseValueAtom(t,e);case"name":case"mean":case"rate":{const e=await this.tokenizer.readToken(new w(n));t+=":".concat(e.name);break}default:{const a=await this.tokenizer.readToken(new s.Uint8ArrayType(n));this.addWarning("Unsupported meta-item: ".concat(t,"[").concat(e.header.name,"] => value=").concat((0,M.EY)(a)," ascii=").concat((0,M.SW)(a,"ascii")))}}},e.getPayloadLength(0))}async parseValueAtom(e,t){const a=await this.tokenizer.readToken(new k(Number(t.header.length)-d.len));if(0!==a.type.set)throw new h("Unsupported type-set != 0: ".concat(a.type.set));switch(a.type.type){case 0:switch(e){case"trkn":case"disk":{const t=s.UINT8.get(a.value,3),n=s.UINT8.get(a.value,5);await this.addTag(e,"".concat(t,"/").concat(n));break}case"gnre":{const t=s.UINT8.get(a.value,1),n=r.jR[t-1];await this.addTag(e,n);break}case"rate":{const t=new TextDecoder("ascii").decode(a.value);await this.addTag(e,t);break}default:R("unknown proprietary value type for: ".concat(t.atomPath))}break;case 1:case 18:await this.addTag(e,new TextDecoder("utf-8").decode(a.value));break;case 13:if(this.options.skipCovers)break;await this.addTag(e,{format:"image/jpeg",data:Uint8Array.from(a.value)});break;case 14:if(this.options.skipCovers)break;await this.addTag(e,{format:"image/png",data:Uint8Array.from(a.value)});break;case 21:await this.addTag(e,V.read_BE_Integer(a.value,!0));break;case 22:await this.addTag(e,V.read_BE_Integer(a.value,!1));break;case 65:await this.addTag(e,s.UINT8.get(a.value,0));break;case 66:await this.addTag(e,s.UINT16_BE.get(a.value,0));break;case 67:await this.addTag(e,s.UINT32_BE.get(a.value,0));break;default:this.addWarning("atom key=".concat(e,", has unknown well-known-type (data-type): ").concat(a.type.type))}}parseSoundSampleDescription(e){const t={dataFormat:e.dataFormat,dataReferenceIndex:e.dataReferenceIndex};let a=0;if(e.description){const n=_.get(e.description,a);a+=_.len,0===n.version||1===n.version?t.description=b.get(e.description,a):R("Warning: sound-sample-description ".concat(n," not implemented"))}return t}async parseChapterTrack(e,t,a){if(!e.sampleSize&&e.chunkOffsetTable.length!==e.sampleSizeTable.length)throw new Error("Expected equal chunk-offset-table & sample-size-table length.");const n=[];for(let s=0;s<e.chunkOffsetTable.length&&a>0;++s){const i=e.chunkOffsetTable[s]-this.tokenizer.position,r=e.sampleSize>0?e.sampleSize:e.sampleSizeTable[s];if((a-=i+r)<0)throw new h("Chapter chunk exceeding token length");await this.tokenizer.ignore(i);const o=await this.tokenizer.readToken(new D(r));R("Chapter ".concat(s+1,": ").concat(o));const c={title:o,sampleOffset:this.findSampleOffset(t,this.tokenizer.position)};R("Chapter title=".concat(c.title,", offset=").concat(c.sampleOffset,"/").concat(this.tracks[0].duration)),n.push(c)}this.metadata.setFormat("chapters",n),await this.tokenizer.ignore(a)}findSampleOffset(e,t){let a=0;e.timeToSampleTable.forEach(e=>{a+=e.count*e.duration}),R("Total duration=".concat(a));let n=0;for(;n<e.chunkOffsetTable.length&&e.chunkOffsetTable[n]<t;)++n;return this.getChunkDuration(n+1,e)}getChunkDuration(e,t){let a=0,n=t.timeToSampleTable[a].count,s=t.timeToSampleTable[a].duration,i=1,r=this.getSamplesPerChunk(i,t.sampleToChunkTable),o=0;for(;i<e;){const e=Math.min(n,r);o+=e*s,n-=e,r-=e,0===r?(++i,r=this.getSamplesPerChunk(i,t.sampleToChunkTable)):(++a,n=t.timeToSampleTable[a].count,s=t.timeToSampleTable[a].duration)}return o}getSamplesPerChunk(e,t){for(let a=0;a<t.length-1;++a)if(e>=t[a].firstChunk&&e<t[a+1].firstChunk)return t[a].samplesPerChunk;return t[t.length-1].samplesPerChunk}}}}]);